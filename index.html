<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chatbot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden; /* ìŠ¤í¬ë¡¤ ì—†ì• ê¸° */
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #000000;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
    }

    #visualizer-container {
      width: 100%;
      height: 70%; /* ì‹œê°í™” ê³µê°„ì„ í™”ë©´ì˜ 75% ì°¨ì§€ */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #visualizer {
      display: flex;
      gap: 10px; /* ê° ì‚¬ê°í˜• ì‚¬ì´ì˜ ê°„ê²© */
      justify-content: center;
      align-items: center;
    }

    .rect {
      width: 100px;  /* ê³ ì •ëœ ë„ˆë¹„ */
      height: 100px; /* ê¸°ë³¸ ë†’ì´ */
      border-radius: 500px; /* ì›í˜• ìœ ì§€ */
      background-color: #00FF97;
      transition: height 0.2s ease-in-out, width 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    #chat-container {
      width: 100%;
      height: 30%; /* ì±„íŒ… ê³µê°„ì„ í™”ë©´ì˜ 25% ì°¨ì§€ */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #000;
      color: #00FF97;
      padding: 20px;
    }

    #controls {
      display: flex;
      gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²©ì„ ë„“ê²Œ */
      margin-bottom: 20px;
    }

    input[type="text"] {
      width: 500px;
      padding: 15px;
      font-size: 18px; /* ì…ë ¥ í•„ë“œ í…ìŠ¤íŠ¸ í¬ê¸° */
      border: none;
      border-radius: 10px;
      background-color: #222;
      color: #00FF97;
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #00FF97;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    button:hover {
      background-color: #00dd80;
    }

    #fullscreen-btn {
      position: fixed; /* ê³ ì •ëœ ìœ„ì¹˜ */
      bottom: 20px; /* í™”ë©´ í•˜ë‹¨ì—ì„œ 20px */
      right: 20px; /* í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ 20px */
      padding: 10px 20px;
      background-color: #000;
      color: #000;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    #fullscreen-btn:hover {
      background-color: #000;
    }

    #transcript, #response {
      margin-top: 10px;
      font-size: 20px; /* í…ìŠ¤íŠ¸ í¬ê¸° */
    }

    #console {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10000;
      width: 100%;
      height: 50px;
      background-color: #fff;
      color: #000;
      font-size: 18px;
      text-align: center;
    }
    #console2 {
      position: fixed;
      top: 80;
      left: 0;
      z-index: 10000;
      width: 100%;
      height: 50px;
      background-color: #fff;
      color: #000;
      font-size: 18px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="console"></div>
  <div id="console2"></div>

  <!-- ì‹œê°í™” ì˜ì—­ -->
  <div id="visualizer-container">
    <div id="visualizer">
      <div class="rect"></div>
      <div class="rect"></div>
      <div class="rect"></div>
      <div class="rect"></div>
    </div>
  </div>

  <!-- ì±„íŒ… ì˜ì—­ -->
  <div id="chat-container">
    <div id="controls">
      <button id="start-record-btn">ìŒì„± ì…ë ¥ ì‹œì‘</button>
      <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="send-btn">ì „ì†¡</button>
    </div>
    <p id="transcript">ì‚¬ìš©ì ì…ë ¥: <span id="user-text"></span></p>
    <p id="response">ì±—ë´‡ ì‘ë‹µ: <span id="bot-text"></span></p>
  </div>

  <!-- ì „ì²´ í™”ë©´ ë²„íŠ¼ -->
  <button id="fullscreen-btn">ì „ì²´ í™”ë©´</button>

  <script>
    const startRecordBtn = document.getElementById("start-record-btn");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const fullscreenBtn = document.getElementById("fullscreen-btn");
    const userTextElement = document.getElementById("user-text");
    const botTextElement = document.getElementById("bot-text");
    const rects = document.querySelectorAll('.rect');

    let audioContext;
    let analyser;
    let microphone;
    let javascriptNode;






    // ----- í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ API ì‚¬ìš©ì´ ìœ íš¨í•œê°€ë¥¼ ê²€ì¦
    function availabilityFunc() {
    //í˜„ì¬ SpeechRecognitionì„ ì§€ì›í•˜ëŠ” í¬ë¡¬ ë²„ì „ê³¼ webkit í˜•íƒœë¡œ ì œê³µë˜ëŠ” ë²„ì „ì´ ìˆìœ¼ë¯€ë¡œ ë‘˜ ì¤‘ í•´ë‹¹í•˜ëŠ” ìƒì„±ìë¥¼ í˜¸ì¶œí•œë‹¤.
    recognition = new webkitSpeechRecognition() || new SpeechRecognition();
    recognition.lang = "ko-KR"; // ìŒì„±ì¸ì‹ì— ì‚¬ìš©ë˜ê³  ë°˜í™˜ë  ì–¸ì–´ë¥¼ ì„¤ì •í•œë‹¤.
    recognition.maxAlternatives = 5; //ìŒì„± ì¸ì‹ê²°ê³¼ë¥¼ 5ê°œ ê¹Œì§€ ë³´ì—¬ì¤€ë‹¤.

    if (!recognition) {
        alert("í˜„ì¬ ë¸Œë¼ìš°ì €ëŠ” ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
    }
    }

    // --- ìŒì„±ë…¹ìŒì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
    function startRecord() {
        console.log("ì‹œì‘");

        // âºï¸í´ë¦­ ì‹œ ìŒì„±ì¸ì‹ì„ ì‹œì‘í•œë‹¤.
        recognition.addEventListener("speechstart", () => {
            //console.log("ì¸ì‹");
            //startAudioVisualization();  // ìŒì„± ì…ë ¥ ì‹œì‘ ì‹œ ì‹œê°í™” ì‹œì‘
        });

        //ìŒì„±ì¸ì‹ì´ ëê¹Œì§€ ì´ë£¨ì–´ì§€ë©´ ì¤‘ë‹¨ëœë‹¤.
        recognition.addEventListener("speechend", () => {
            console.log("ì¸ì‹2");
            document.getElementById('console2').textContent = 'ìŒì„±ì¸ì‹ ì¢…ë£Œ...';
            //userTextElement.textContent = "end...";
        });

        //ìŒì„±ì¸ì‹ ê²°ê³¼ë¥¼ ë°˜í™˜
        // SpeechRecognitionResult ì— ë‹´ê²¨ì„œ ë°˜í™˜ëœë‹¤.
        recognition.addEventListener("result", (e) => {
            //searchConsole.value = e.results[0][0].transcript;
            //userTextElement.textContent = e.results[0][0].transcript;  // ì‚¬ìš©ì ì…ë ¥ ìë§‰ í‘œì‹œ
            document.getElementById('console').textContent = e.results[0][0].transcript;
        });

        recognition.start();
    }

    //  ğŸ›‘ í´ë¦­ ì‹œ ì¢…ë£Œ(ì•ˆ ëˆŒëŸ¬ë„ ìŒì„±ì¸ì‹ì€ ì•Œì•„ì„œ ì¢…ë£Œë¨)
    function endRecord() {
        console.log("ì¢…ë£Œ");
        recognition.stop(); // ìŒì„±ì¸ì‹ì„ ì¤‘ë‹¨í•˜ê³  ì¤‘ë‹¨ê¹Œì§€ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜
    }

    window.addEventListener("load", availabilityFunc);





/*
    // ìŒì„± ì…ë ¥ ì²˜ë¦¬
    function startVoiceRecognition() {
      if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.start();
        recognition.onstart = () => {
          startAudioVisualization();  // ìŒì„± ì…ë ¥ ì‹œì‘ ì‹œ ì‹œê°í™” ì‹œì‘
        };
        recognition.onend = () => {
          stopAudioVisualization();   // ìŒì„± ì…ë ¥ ì¢…ë£Œ ì‹œ ì‹œê°í™” ì¤‘ë‹¨
        };
        recognition.onresult = async (event) => {
          const transcript = event.results[0][0].transcript;
          handleUserInput(transcript);
        };

      } else if (annyang) {
        const commands = {
          '*userInput': function (userInput) {
            handleUserInput(userInput);
          }
        };
        annyang.addCommands(commands);

        annyang.start({ continuous: false });
        startAudioVisualization();

        annyang.addCallback('end', () => {
          stopAudioVisualization();
        });

      } else {
        alert('ìŒì„± ì¸ì‹ì€ ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      }
    }
      */


      /*
    // í…ìŠ¤íŠ¸ ì…ë ¥ ì²˜ë¦¬
    sendBtn.addEventListener("click", () => {
      const userInput = chatInput.value;
      if (userInput) {
        handleUserInput(userInput);
        chatInput.value = ""; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      }
    });

    // ì „ì²´ í™”ë©´ ë²„íŠ¼ ì²˜ë¦¬
    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch((err) => {
          console.log(`Error attempting to enable full-screen mode: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // ì‚¬ìš©ì ì…ë ¥ì„ ì²˜ë¦¬í•˜ê³  ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
    async function handleUserInput(userInput) {
      userTextElement.textContent = userInput;  // ì‚¬ìš©ì ì…ë ¥ ìë§‰ í‘œì‹œ

      // ì„œë²„ì— í…ìŠ¤íŠ¸ë¥¼ ì „ì†¡í•˜ì—¬ ì‘ë‹µì„ ë°›ìŒ
      try {
        const response = await fetch('https://potizchat.vercel.app/api/chat', {  // ìˆ˜ì •ëœ ê²½ë¡œ
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userInput }),
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        const botResponse = data.botResponse;

        botTextElement.textContent = botResponse;  // ì±—ë´‡ ì‘ë‹µ ìë§‰ í‘œì‹œ
        speakBotResponse(botResponse); // ì±—ë´‡ ì‘ë‹µì— ë”°ë¥¸ TTS ì‹¤í–‰
      } catch (error) {
        console.error('Error:', error);
        botTextElement.textContent = "Error occurred while communicating with the server.";
      }
    }

    // ì±—ë´‡ ì‘ë‹µì„ TTSë¡œ ì½ì–´ì£¼ê³  ì‹œê°í™” ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬
    function speakBotResponse(botResponse) {
      const utterance = new SpeechSynthesisUtterance(botResponse);
      utterance.lang = 'ko-KR';
      window.speechSynthesis.speak(utterance);

      utterance.onstart = () => {
        startAudioVisualization();  // ì‘ë‹µ ì½ì„ ë•Œ ì‹œê°í™” ì‹œì‘
      };

      utterance.onend = () => {
        stopAudioVisualization();   // ì‘ë‹µ ì½ê¸° ì¢…ë£Œ ì‹œ ì‹œê°í™” ì¤‘ë‹¨
        resetVisualizer();           // ì‹œê°í™” ì¢…ë£Œ í›„ ì› ìƒíƒœë¡œ ë³µê·€
      };
    }

    // ìŒì„± ì…ë ¥ì— ë”°ë¼ ì‹œê°í™” ì• ë‹ˆë©”ì´ì…˜ ì¡°ì ˆ
    function startAudioVisualization() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 32;

      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        microphone = audioContext.createMediaStreamSource(stream);
        javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
       
        microphone.connect(analyser);
        analyser.connect(javascriptNode);
        javascriptNode.connect(audioContext.destination);

        javascriptNode.onaudioprocess = function () {
          const array = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(array);

          const avgVolume = array.reduce((a, b) => a + b) / array.length;
          updateVisualizer(avgVolume);
        };
      }).catch(err => {
        console.error('ë§ˆì´í¬ ì ‘ê·¼ ì¤‘ ì˜¤ë¥˜:', err);
        alert('ë§ˆì´í¬ ì‚¬ìš©ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
      });
    }

    function stopAudioVisualization() {
      if (microphone) {
        microphone.disconnect();
      }
      if (javascriptNode) {
        javascriptNode.disconnect();
      }
    }

    // ì†Œë¦¬ í¬ê¸°ì— ë”°ë¼ ì‹œê°í™” ì—…ë°ì´íŠ¸ (ë³€ê²½ëœ ë¶€ë¶„)
    function updateVisualizer(volume) {
      const maxHeights = [200, 140, 170, 140];  // ê° ë§‰ëŒ€ì˜ ìµœëŒ€ í¬ê¸°
      const scaleFactor = 1.5;  // ì†Œë¦¬ í¬ê¸°ì— ë”°ë¥¸ ë³€í™”ëŸ‰ì„ ë” ê·¹ëŒ€í™”
      const glowFactor = 10;  // ê¸€ë¡œìš° íš¨ê³¼ì˜ í¬ê¸°ë¥¼ ì¡°ì •

      rects.forEach((rect, index) => {
        const maxHeight = maxHeights[index];
        // ì†Œë¦¬ í¬ê¸° ë°˜ì˜ (scaleFactorë¥¼ ì‚¬ìš©í•´ ë°˜ì‘ì„ ë” ê·¹ëŒ€í™”)
        const scaledVolume = Math.min(maxHeight, Math.max(30, volume * scaleFactor));

        // ê° ë§‰ëŒ€ì˜ í¬ê¸°ì™€ ë°˜ì‘ ì†ë„ë¥¼ ì¡°ì •
        if (volume > index * 1.5) {
          rect.style.height = `${scaledVolume}px`;
          rect.style.width = `${scaledVolume/1}px`;  // ì†Œë¦¬ í¬ê¸°ì— ë”°ë¼ ë„ˆë¹„ë„ ë³€í™”
          rect.style.borderRadius = `${scaledVolume / 2}px`;  // ì›í˜• ë¹„ìœ¨ì„ ìœ ì§€
          rect.style.boxShadow = `0 0 ${volume * glowFactor}px rgba(0, 255, 151, 0.8)`;  // ê¸€ë¡œìš° íš¨ê³¼
          rect.style.transition = 'height 0.1s ease-out, width 0.1s ease-out, box-shadow 0.1s ease-out';
        } else {
          rect.style.height = '100px';
          rect.style.width = '110px';
          rect.style.boxShadow = 'none';
          rect.style.transition = 'height 0.2s ease-out, width 0.2s ease-out, box-shadow 0.2s ease-out';  // ì‘ì•„ì§ˆ ë•ŒëŠ” ì²œì²œíˆ
        }
      });
    }

    // ì‹œê°í™”ê°€ ëë‚¬ì„ ë•Œ ì›ë˜ í¬ê¸°ë¡œ ë³µê·€
    function resetVisualizer() {
      rects.forEach(rect => {
        rect.style.height = '110px';
        rect.style.width = '110px';
        rect.style.borderRadius = '300px';
        rect.style.boxShadow = 'none';
      });
    }

    // ë§ˆì´í¬ ê¶Œí•œ í™•ì¸
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function (stream) {
        console.log("ë§ˆì´í¬ ì ‘ê·¼ í—ˆìš©ë¨");
      })
      .catch(function (err) {
        console.error("ë§ˆì´í¬ ì ‘ê·¼ ê±°ë¶€ë¨", err);
        alert('ë§ˆì´í¬ ì‚¬ìš©ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
      });
      */

    //startRecordBtn.addEventListener("click", startVoiceRecognition);
    startRecordBtn.addEventListener("click", startRecord);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/annyang@2.6.1/dist/annyang.min.js"></script>

</body>
</html>